---
header-includes: 
    \usepackage{titling}
    \pretitle{
      \begin{center}
      \includegraphics[width=\textwidth]{`r system.file("reports/presto.jpg", package="prestor")`}
      \end{center}
    }
    \posttitle{}
output:
    pdf_document:
        toc: true
    html_document:
        toc: true
params:
    title: "pRESTO FLAIRR Report"
    sample: "Sample"
    locus: "Locus"
    data: ""
    config_file: ""


title: "`r params$title`"
---




```{r includes, echo=FALSE, results="hide", warning = FALSE, message = FALSE}

# From the command line: R -e "rmarkdown::render('../presto_r/FLAIRR.Rmd', params=list(data='../processed_samples/1001-667/results/reports', sample='1001-667'), output_file='../processed_samples/1001-667/1001-667_presto.pdf')"

# Imports
library(knitr)
library(captioner)
library(scales)
library(alakazam)
library(bibtex)
library(rlang)
library(stats)
library(stringi)
library(tidyr)
library(utils)
library(configr)
library(dplyr)
library(prestor)
```


```{r, setup, child="Setup.Rmd", results="hide"}
```

```{r files, echo=FALSE, message=FALSE, results="hide", eval=TRUE}

# Function to get file to process, using the toml config

file_config = read.config(file.path(params$config_file))

str(file_config)

get_log_file <- function(phase, config, sample) {
  phase_found <- FALSE
  template_path <- NULL

  for (element in file_config$sample_files) {
    if (element[1] == phase) {
      phase_found <- TRUE
      template = stri_replace_all_fixed(element[2], "{sample}", sample)
      template_path <- file.path(params$data, template)
      matched_files <- Sys.glob(template_path)

      if (length(matched_files) == 1) {
        return(list(file = matched_files[1], phase_found = phase_found, template_path = template_path, found = TRUE))
      } else {
        return(list(file = NULL, phase_found = phase_found, template_path = template_path, found = FALSE))
      }
    }
  }
  return(list(file = NULL, phase_found = phase_found, template_path = template_path, found = FALSE))
}

# Get log files and their diagnostic information
quality_result = get_log_file('filterSeq_quality', file_config, params$sample)
length_result = get_log_file('filterSeq_length', file_config, params$sample)
primer_result_1 = get_log_file('maskPrimer_C', file_config, params$sample)
primer_result_2 = get_log_file('maskPrimer_V', file_config, params$sample)
align_result = get_log_file('alignSets', file_config, params$sample)
total_result = get_log_file('total', file_config, params$sample)
unique_result = get_log_file('unique', file_config, params$sample)
atleast2_result = get_log_file('unique_atleast2', file_config, params$sample)

# Extract file paths for backward compatibility
quality_log_file = quality_result$file
length_log_file = length_result$file
primer_log_file_1 = primer_result_1$file
primer_log_file_2 = primer_result_2$file
align_log_file = align_result$file
log_file_total = total_result$file
log_file_unique = unique_result$file
log_file_atleast2 = atleast2_result$file

# Create diagnostic output
log_phases <- list(
  "filterSeq_quality" = quality_result,
  "filterSeq_length" = length_result,
  "maskPrimer_C" = primer_result_1,
  "maskPrimer_V" = primer_result_2,
  "alignSets" = align_result,
  "total" = total_result,
  "unique" = unique_result,
  "unique_atleast2" = atleast2_result
)
```

```{r, front, child="Front.Rmd", eval=TRUE}
```

\newpage

## Log File Diagnostics

```{r diagnostics, echo=FALSE, results="asis"}
cat("### File Detection Results\n\n")

# Function to wrap long paths with hyphens
wrap_path <- function(path, max_length = 60) {
  if (nchar(path) <= max_length) {
    return(path)
  }
  
  # Split path into components
  parts <- strsplit(path, "/")[[1]]
  result <- ""
  current_line <- ""
  
  for (i in seq_along(parts)) {
    part <- parts[i]
    test_line <- if (current_line == "") part else paste0(current_line, "/", part)
    
    if (nchar(test_line) <= max_length) {
      current_line <- test_line
    } else {
      if (current_line != "") {
        result <- paste0(result, current_line, "-\n")
        current_line <- part
      } else {
        # Single part is too long, break it
        while (nchar(part) > max_length) {
          result <- paste0(result, substr(part, 1, max_length), "-\n")
          part <- substr(part, max_length + 1, nchar(part))
        }
        current_line <- part
      }
    }
  }
  
  if (current_line != "") {
    result <- paste0(result, current_line)
  }
  
  return(result)
}

for (phase_name in names(log_phases)) {
  result <- log_phases[[phase_name]]
  
  if (result$found) {
    wrapped_path <- wrap_path(result$file)
    cat(sprintf("**%s**: ✓ Found at `%s`\n\n", phase_name, wrapped_path))
  } else {
    if (result$phase_found) {
      wrapped_path <- wrap_path(result$template_path)
      cat(sprintf("**%s**: ✗ Phase found in config but file not found at `%s`\n\n", phase_name, wrapped_path))
    } else {
      cat(sprintf("**%s**: ✗ Phase not found in file_config\n\n", phase_name))
    }
  }
}
```

\newpage

```{r, quality, child="Single-Quality.Rmd", quality_log_file=quality_log_file, eval=!is.null(quality_log_file)}
```

```{r, length, child="Single-Length.Rmd", length_log_file=length_log_file, eval=!is.null(length_log_file)}
```

```{r, length, child="MaskPrimers.Rmd", primer_log_file_1=primer_log_file_1, primer_log_file_2=primer_log_file_2, eval=(!is.null(primer_log_file_1) && !is.null(primer_log_file_2))}
```

```{r, length, child="Single-Align.Rmd", align_log_file=align_log_file, eval=!is.null(align_log_file)}
```

```{r, length, child="Presto-Output.Rmd", log_file_total=log_file_total, log_file_unique=log_file_unique, log_file_atleast2=log_file_atleast2, eval=!is.null(log_file_atleast2)}
```
